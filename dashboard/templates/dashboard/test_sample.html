{% extends 'dashboard/base.html' %}

{% block title %}Test with Sample{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Test with Sample</h1>
                <p class="text-gray-600 mt-1">Test your WhatsApp API functionality with sample requests</p>
            </div>
            <div class="flex items-center space-x-2">
                <label class="flex items-center">
                    <input type="checkbox" id="advancedMode" class="form-checkbox h-4 w-4 text-teal-600">
                    <span class="ml-2 text-sm text-gray-700">Advanced Mode</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Note Section -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>Note:</strong> In case the instance is not authorized, the message will be added to queue and will be sent when the WhatsApp instance is ready.
                </p>
            </div>
        </div>
    </div>

    <!-- API Key Help Section -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-key text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Need an API Key?</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p>To test the API, you need a raw API key. Generate one from the <a href="{% url 'dashboard:api_keys' %}" class="font-medium text-yellow-800 hover:text-yellow-900 underline">API Keys page</a> and copy the key that appears after creation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content - 2 Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left Column - Tabbed Interface -->
        <div class="bg-white shadow rounded-lg">
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="sendTab" class="border-teal-500 text-teal-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message
                    </button>
                    <button id="requestTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-code mr-2"></i>Request
                    </button>
                    <button id="responseTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-check-circle mr-2"></i>Response
                    </button>
                </nav>
            </div>

            <!-- Send Message Tab Content -->
            <div id="sendContent" class="p-6">
                <form id="testForm" class="space-y-4">
                    <!-- API Key Field -->
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">
                            API Key <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="apiKey" name="apiKey" placeholder="Enter your API key" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>
                        <p class="text-xs text-gray-500 mt-1">Enter your raw API key (get it from <a href="{% url 'dashboard:api_keys' %}" class="text-teal-600 hover:text-teal-800">API Keys page</a>)</p>
                    </div>

                    <!-- Recipient Field -->
                    <div>
                        <label for="recipient" class="block text-sm font-medium text-gray-700 mb-1">
                            Recipient <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="recipient" name="recipient" placeholder="+1408XXXXXXX" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>
                        <p class="text-xs text-gray-500 mt-1">Phone with international format e.g. +1408XXXXXXX, or chatID for contact or group</p>
                    </div>

                    <!-- Message Field -->
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
                            Message <span class="text-red-500">*</span>
                        </label>
                        <textarea id="message" name="message" rows="4" placeholder="WhatsApp API on myweb.com works good"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>Test message from SanaSend</textarea>
                        <p class="text-xs text-gray-500 mt-1">Message text, UTF-8 or UTF-16 string with emoji Max length: 4096 characters.</p>
                    </div>

                    <!-- Send Button -->
                    <button type="submit" class="w-full bg-teal-600 text-white py-3 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        <i class="fas fa-paper-plane mr-2"></i> Send Message
                    </button>
                </form>
            </div>

            <!-- Request Content -->
            <div id="requestContent" class="p-6 hidden">
                <!-- Request URL -->
                <div class="mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-green-800 mb-2">Request URL</h3>
                        <div class="bg-white border border-green-200 rounded p-3">
                            <code class="text-sm text-gray-800" id="requestUrl">{{ api_base_url }}/messages/send-text/</code>
                        </div>
                    </div>
                </div>

                <!-- Request Headers -->
                <div class="mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-green-800 mb-2">Request Headers</h3>
                        <div class="bg-white border border-green-200 rounded p-3">
                            <pre class="text-sm text-gray-800">{
  "Content-Type": "application/json",
  "Accept": "application/json",
  "Authorization": "ApiKey YOUR_API_KEY_HERE"
}</pre>
                        </div>
                    </div>
                </div>

                <!-- Request Body -->
                <div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-green-800 mb-2">Request Body</h3>
                        <div class="bg-white border border-green-200 rounded p-3">
                            <pre class="text-sm text-gray-800" id="requestBody">{
  "recipient": "",
  "message": ""
}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Content -->
            <div id="responseContent" class="p-6 hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-800 mb-2">Response</h3>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <pre class="text-sm text-gray-800" id="responseBody">Click "Send Message" to see the response here...</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - PHP Code Sample & Response Types -->
        <div class="bg-white shadow rounded-lg">
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="phpCodeTab" class="border-teal-500 text-teal-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">
                        <i class="fab fa-php mr-2"></i>PHP Sample
                    </button>
                    <button id="responseTypesTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-list-ul mr-2"></i>Response Types
                    </button>
                </nav>
            </div>

            <!-- PHP Code Tab Content -->
            <div id="phpCodeContent" class="p-6">
                <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                    <pre class="text-sm text-green-400"><code>&lt;?php
// WhatsApp API Test Sample
$apiUrl = '{{ api_base_url }}/messages/send-text/';
$apiKey = 'YOUR_API_KEY_HERE';
$recipient = '+1408XXXXXXX';
$message = 'Test message from SanaSend';

// Prepare the data
$data = [
    'recipient' => $recipient,
    'message' => $message
];

// Initialize cURL
$ch = curl_init();

// Set cURL options
curl_setopt($ch, CURLOPT_URL, $apiUrl);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Accept: application/json',
    'Authorization: ApiKey ' . $apiKey
]);

// Execute the request
$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

// Check for errors
if (curl_errno($ch)) {
    echo 'cURL Error: ' . curl_error($ch);
} else {
    echo "HTTP Code: " . $httpCode . "\n";
    echo "Response: " . $response . "\n";
}

// Close cURL
curl_close($ch);
?&gt;</code></pre>
                </div>

                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">Usage Instructions:</h4>
                    <ol class="text-xs text-blue-700 space-y-1">
                        <li>1. Replace YOUR_API_KEY_HERE with your actual API key</li>
                        <li>2. Update the phone number in the $recipient variable</li>
                        <li>3. Modify the message text as needed</li>
                        <li>4. Run the script to test your API</li>
                    </ol>
                </div>
            </div>

            <!-- Response Types Tab Content -->
            <div id="responseTypesContent" class="p-6 hidden">
                <div class="space-y-4">
                    
                    <!-- Success Response -->
                    <div>
                        <h3 class="text-sm font-semibold text-green-700 mb-2 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>Success Response (200 OK)
                        </h3>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": true,
  "message": "Message sent successfully",
  "data": {
    "message_id": "3EB0C1A1B2C3D4E5F6",
    "status": "sent",
    "recipient": "+1408XXXXXXX",
    "timestamp": "2025-10-05T12:34:56Z"
  }
}</pre>
                        </div>
                    </div>

                    <!-- Message Queued Response -->
                    <div>
                        <h3 class="text-sm font-semibold text-blue-700 mb-2 flex items-center">
                            <i class="fas fa-clock mr-2"></i>Message Queued (202 Accepted)
                        </h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": true,
  "message": "Message queued - WhatsApp session not ready",
  "data": {
    "message_id": "queue_3EB0C1A1B2C3D4E5F6",
    "status": "queued",
    "recipient": "+1408XXXXXXX"
  }
}</pre>
                        </div>
                    </div>

                    <!-- Validation Error Response -->
                    <div>
                        <h3 class="text-sm font-semibold text-red-700 mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Validation Error (400 Bad Request)
                        </h3>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": false,
  "message": "Validation failed",
  "errors": {
    "recipient": ["This field is required."],
    "message": ["This field cannot be blank."]
  }
}</pre>
                        </div>
                    </div>

                    <!-- Authentication Error -->
                    <div>
                        <h3 class="text-sm font-semibold text-red-700 mb-2 flex items-center">
                            <i class="fas fa-lock mr-2"></i>Authentication Error (401 Unauthorized)
                        </h3>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": false,
  "message": "Invalid API key",
  "error_code": "INVALID_API_KEY"
}</pre>
                        </div>
                    </div>

                    <!-- Rate Limit Error -->
                    <div>
                        <h3 class="text-sm font-semibold text-orange-700 mb-2 flex items-center">
                            <i class="fas fa-tachometer-alt mr-2"></i>Rate Limit (429 Too Many Requests)
                        </h3>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": false,
  "message": "Rate limit exceeded",
  "error_code": "RATE_LIMIT_EXCEEDED",
  "retry_after": 60
}</pre>
                        </div>
                    </div>

                    <!-- Server Error -->
                    <div>
                        <h3 class="text-sm font-semibold text-red-700 mb-2 flex items-center">
                            <i class="fas fa-server mr-2"></i>Server Error (500 Internal Server Error)
                        </h3>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <pre class="text-xs text-gray-800">{
  "success": false,
  "message": "Internal server error",
  "error_code": "SERVER_ERROR"
}</pre>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('testForm');
    const apiKeyInput = document.getElementById('apiKey');
    const recipientInput = document.getElementById('recipient');
    const messageInput = document.getElementById('message');
    const requestUrl = document.getElementById('requestUrl');
    const requestBody = document.getElementById('requestBody');
    const responseBody = document.getElementById('responseBody');
    
    // Tab elements
    const sendTab = document.getElementById('sendTab');
    const requestTab = document.getElementById('requestTab');
    const responseTab = document.getElementById('responseTab');
    
    // Content elements
    const sendContent = document.getElementById('sendContent');
    const requestContent = document.getElementById('requestContent');
    const responseContent = document.getElementById('responseContent');

    // Tab switching function
    function switchTab(activeTab, activeContent) {
        // Hide all content
        [sendContent, requestContent, responseContent].forEach(content => {
            content.classList.add('hidden');
        });
        
        // Reset all tabs
        [sendTab, requestTab, responseTab].forEach(tab => {
            tab.classList.remove('border-teal-500', 'text-teal-600');
            tab.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show active content and tab
        activeContent.classList.remove('hidden');
        activeTab.classList.add('border-teal-500', 'text-teal-600');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
    }

    // Tab click handlers
    sendTab.addEventListener('click', () => switchTab(sendTab, sendContent));
    requestTab.addEventListener('click', () => switchTab(requestTab, requestContent));
    responseTab.addEventListener('click', () => switchTab(responseTab, responseContent));

    // Right column tabs
    const phpCodeTab = document.getElementById('phpCodeTab');
    const responseTypesTab = document.getElementById('responseTypesTab');
    const phpCodeContent = document.getElementById('phpCodeContent');
    const responseTypesContent = document.getElementById('responseTypesContent');

    // Right column tab switching
    function switchRightTab(activeTab, activeContent) {
        // Hide all right column content
        [phpCodeContent, responseTypesContent].forEach(content => {
            content.classList.add('hidden');
        });
        
        // Reset all right column tabs
        [phpCodeTab, responseTypesTab].forEach(tab => {
            tab.classList.remove('border-teal-500', 'text-teal-600');
            tab.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show active content and tab
        activeContent.classList.remove('hidden');
        activeTab.classList.add('border-teal-500', 'text-teal-600');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
    }

    // Right column tab click handlers
    phpCodeTab.addEventListener('click', () => switchRightTab(phpCodeTab, phpCodeContent));
    responseTypesTab.addEventListener('click', () => switchRightTab(responseTypesTab, responseTypesContent));

    // Update request body when form changes
    function updateRequestBody() {
        const recipient = recipientInput.value;
        const message = messageInput.value;
        
        const requestData = {
            recipient: recipient,
            message: message
        };
        
        requestBody.textContent = JSON.stringify(requestData, null, 2);
    }

    // Update request body on form changes
    recipientInput.addEventListener('input', updateRequestBody);
    messageInput.addEventListener('input', updateRequestBody);

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const apiKey = apiKeyInput.value;
        const recipient = recipientInput.value;
        const message = messageInput.value;
        
        if (!apiKey || !recipient || !message) {
            alert('Please fill in all required fields');
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';
        submitBtn.disabled = true;

        // Prepare request data
        const requestData = {
            recipient: recipient,
            message: message
        };

        // Make API request
        fetch('{{ api_base_url }}/messages/send-text/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'ApiKey ' + apiKey
            },
            body: JSON.stringify(requestData)
        })
        .then(async response => {
            const contentType = response.headers.get('content-type');
            
            // Check if response is JSON
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                return { ok: response.ok, status: response.status, data: data };
            } else {
                // Non-JSON response (likely an error page)
                const text = await response.text();
                return { 
                    ok: false, 
                    status: response.status, 
                    error: 'Server returned non-JSON response',
                    text: text.substring(0, 500) // First 500 chars for debugging
                };
            }
        })
        .then(result => {
            if (result.data) {
                // JSON response received
                responseBody.textContent = JSON.stringify(result.data, null, 2);
                switchTab(responseTab, responseContent);
                
                if (result.ok && result.data.success !== false) {
                    alert('Message sent successfully!');
                } else {
                    alert('Error: ' + (result.data.message || 'Unknown error'));
                }
            } else {
                // Non-JSON response
                responseBody.textContent = `HTTP ${result.status} - ${result.error}\n\nResponse preview:\n${result.text}`;
                switchTab(responseTab, responseContent);
                alert(`Error: Server returned non-JSON response (HTTP ${result.status}). Check the Response tab for details.`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            responseBody.textContent = 'Network Error: ' + error.message + '\n\nThis could be due to:\n- CORS issues\n- Network connectivity\n- Server not responding';
            switchTab(responseTab, responseContent);
            alert('Network error: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Initialize request body
    updateRequestBody();
});
</script>
{% endblock %}
