{% extends 'dashboard/base.html' %}

{% block title %}Test with Sample{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Test with Sample</h1>
                <p class="text-gray-600 mt-1">Test your WhatsApp API functionality with sample requests</p>
            </div>
            <div class="flex items-center space-x-2">
                <label class="flex items-center">
                    <input type="checkbox" id="advancedMode" class="form-checkbox h-4 w-4 text-teal-600">
                    <span class="ml-2 text-sm text-gray-700">Advanced Mode</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Note Section -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>Note:</strong> In case the instance is not authorized, the message will be added to queue and will be sent when the WhatsApp instance is ready.
                </p>
            </div>
        </div>
    </div>

    <!-- API Key Help Section -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-key text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Need an API Key?</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p>To test the API, you need a raw API key. Generate one from the <a href="{% url 'dashboard:api_keys' %}" class="font-medium text-yellow-800 hover:text-yellow-900 underline">API Keys page</a> and copy the key that appears after creation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content - 2 Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left Column - Form and PHP Code -->
        <div class="space-y-6">
            <!-- Send Message Form -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Send Test Message</h2>
                
                <form id="testForm" class="space-y-4">
                    <!-- API Key Field -->
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">
                            API Key <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="apiKey" name="apiKey" placeholder="Enter your API key" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>
                        <p class="text-xs text-gray-500 mt-1">Enter your raw API key (get it from <a href="{% url 'dashboard:api_keys' %}" class="text-teal-600 hover:text-teal-800">API Keys page</a>)</p>
                    </div>

                    <!-- Recipient Field -->
                    <div>
                        <label for="recipient" class="block text-sm font-medium text-gray-700 mb-1">
                            Recipient <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="recipient" name="recipient" placeholder="+1408XXXXXXX" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>
                        <p class="text-xs text-gray-500 mt-1">Phone with international format e.g. +1408XXXXXXX, or chatID for contact or group</p>
                    </div>

                    <!-- Message Field -->
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
                            Message <span class="text-red-500">*</span>
                        </label>
                        <textarea id="message" name="message" rows="3" placeholder="WhatsApp API on myweb.com works good"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" required>WhatsApp API on myweb.com works good</textarea>
                        <p class="text-xs text-gray-500 mt-1">Message text, UTF-8 or UTF-16 string with emoji Max length: 4096 characters.</p>
                    </div>

                    <!-- Send Button -->
                    <button type="submit" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        <i class="fas fa-paper-plane mr-2"></i> Send
                    </button>
                </form>
            </div>

            <!-- PHP Code Sample -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">PHP Code Sample</h2>
                
                <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                    <pre class="text-sm text-green-400"><code>&lt;?php
// WhatsApp API Test Sample
$apiUrl = '{{ api_base_url }}/messages/send-text/';
$apiKey = 'YOUR_API_KEY_HERE';
$recipient = '+1408XXXXXXX';
$message = 'WhatsApp API on myweb.com works good';

// Prepare the data
$data = [
    'recipient' => $recipient,
    'message' => $message
];

// Initialize cURL
$ch = curl_init();

// Set cURL options
curl_setopt($ch, CURLOPT_URL, $apiUrl);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Accept: application/json',
    'Authorization: ApiKey ' . $apiKey
]);

// Execute the request
$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

// Check for errors
if (curl_errno($ch)) {
    echo 'cURL Error: ' . curl_error($ch);
} else {
    echo "HTTP Code: " . $httpCode . "\n";
    echo "Response: " . $response . "\n";
}

// Close cURL
curl_close($ch);
?&gt;</code></pre>
                </div>

                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">Usage Instructions:</h4>
                    <ol class="text-xs text-blue-700 space-y-1">
                        <li>1. Replace YOUR_API_KEY_HERE with your actual API key</li>
                        <li>2. Update the phone number in the $recipient variable</li>
                        <li>3. Modify the message text as needed</li>
                        <li>4. Run the script to test your API</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Right Column - Request/Response Tabs -->
        <div class="bg-white shadow rounded-lg">
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="requestTab" class="border-teal-500 text-teal-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm active">
                        Request
                    </button>
                    <button id="responseTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Response
                    </button>
                </nav>
            </div>

            <!-- Request Content -->
            <div id="requestContent" class="p-6">
                <!-- Request URL -->
                <div class="mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-green-800 mb-2">Request URL</h3>
                        <div class="bg-white border border-green-200 rounded p-3">
                            <code class="text-sm text-gray-800" id="requestUrl">{{ api_base_url }}/messages/send-text/</code>
                        </div>
                    </div>
                </div>

                <!-- Request Body -->
                <div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-green-800 mb-2">Request Body</h3>
                        <div class="bg-white border border-green-200 rounded p-3">
                            <pre class="text-sm text-gray-800" id="requestBody">{
  "recipient": "",
  "message": ""
}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Content -->
            <div id="responseContent" class="p-6 hidden">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-800 mb-2">Response</h3>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <pre class="text-sm text-gray-800" id="responseBody">Click "Send" to see the response here...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('testForm');
    const apiKeySelect = document.getElementById('apiKey');
    const recipientInput = document.getElementById('recipient');
    const messageInput = document.getElementById('message');
    const requestUrl = document.getElementById('requestUrl');
    const requestBody = document.getElementById('requestBody');
    const responseContent = document.getElementById('responseContent');
    const responseBody = document.getElementById('responseBody');
    const requestTab = document.getElementById('requestTab');
    const responseTab = document.getElementById('responseTab');
    const requestContent = document.getElementById('requestContent');

    // Update request body when form changes
    function updateRequestBody() {
        const recipient = recipientInput.value;
        const message = messageInput.value;
        
        const requestData = {
            recipient: recipient,
            message: message
        };
        
        requestBody.textContent = JSON.stringify(requestData, null, 2);
    }

    // Tab switching
    requestTab.addEventListener('click', function() {
        requestTab.classList.add('border-teal-500', 'text-teal-600');
        requestTab.classList.remove('border-transparent', 'text-gray-500');
        responseTab.classList.remove('border-teal-500', 'text-teal-600');
        responseTab.classList.add('border-transparent', 'text-gray-500');
        requestContent.classList.remove('hidden');
        responseContent.classList.add('hidden');
    });

    responseTab.addEventListener('click', function() {
        responseTab.classList.add('border-teal-500', 'text-teal-600');
        responseTab.classList.remove('border-transparent', 'text-gray-500');
        requestTab.classList.remove('border-teal-500', 'text-teal-600');
        requestTab.classList.add('border-transparent', 'text-gray-500');
        responseContent.classList.remove('hidden');
        requestContent.classList.add('hidden');
    });

    // Update request body on form changes
    recipientInput.addEventListener('input', updateRequestBody);
    messageInput.addEventListener('input', updateRequestBody);

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const apiKey = apiKeySelect.value;
        const recipient = recipientInput.value;
        const message = messageInput.value;
        
        if (!apiKey || !recipient || !message) {
            alert('Please fill in all required fields');
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';
        submitBtn.disabled = true;

        // Prepare request data
        const requestData = {
            recipient: recipient,
            message: message
        };

        // Make API request
        fetch('{{ api_base_url }}/messages/send-text/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'ApiKey ' + apiKey
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Show response
            responseBody.textContent = JSON.stringify(data, null, 2);
            responseTab.click(); // Switch to response tab
            
            // Show success/error message
            if (data.success !== false) {
                alert('Message sent successfully!');
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            responseBody.textContent = 'Error: ' + error.message;
            responseTab.click(); // Switch to response tab
            alert('Error sending message: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Initialize request body
    updateRequestBody();
});
</script>
{% endblock %}
