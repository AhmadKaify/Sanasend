{% extends 'dashboard/base.html' %}

{% block title %}WhatsApp Session{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="page-header">
        <h1 class="page-title">WhatsApp Session Management</h1>
    </div>
    
    <!-- Summary Card -->
    <div class="card p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">WhatsApp Instances</h2>
                <p class="text-sm text-gray-500 mt-1">Manage up to 10 WhatsApp instances per account</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-gray-900">{{ sessions|length }}/10</div>
                <div class="text-xs text-gray-500">Active Instances</div>
            </div>
        </div>

        <!-- Add New Instance Button -->
        <div class="mb-6">
            {% if sessions|length < 10 %}
                <button onclick="showAddInstanceModal()" class="btn-primary inline-flex items-center px-4 py-2.5 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2" style="--tw-ring-color: var(--primary-500);">
                    <i class="fas fa-plus mr-2"></i>
                    Add New WhatsApp Instance
                </button>
            {% else %}
                <div class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-500 rounded-lg text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    Maximum instances reached (10/10)
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Sessions Grid -->
    {% if sessions %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        {% for session in sessions %}
        <div class="card p-6 border-l-4 {% if session.is_primary %}border-teal-500{% else %}border-gray-300{% endif %}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">{{ session.instance_name }}</h3>
                        {% if session.is_primary %}
                            <span class="px-2 py-1 text-xs font-medium bg-teal-100 text-teal-800 rounded-full">Primary</span>
                        {% endif %}
                    </div>
                    <p class="text-xs text-gray-500 font-mono break-all">{{ session.session_id }}</p>
            </div>
            <div>
                    {% if session.status == 'connected' %}
                        <span class="status-badge px-3 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <span class="pulse-dot bg-green-500"></span>
                            Connected
                        </span>
                    {% elif session.status == 'qr_pending' %}
                        <span class="status-badge px-3 py-1.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <span class="pulse-dot bg-yellow-500"></span>
                            QR Pending
                        </span>
                    {% elif session.status == 'initializing' %}
                        <span class="status-badge px-3 py-1.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <span class="pulse-dot bg-blue-500"></span>
                            Initializing
                        </span>
                    {% else %}
                        <span class="status-badge px-3 py-1.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <span class="pulse-dot bg-red-500"></span>
                            Disconnected
                        </span>
                    {% endif %}
                </div>
            </div>

            {% if session.phone_number %}
                <div class="mb-3 text-sm text-gray-600">
                    <i class="fas fa-phone mr-1"></i> +{{ session.phone_number }}
        </div>
            {% endif %}

        <!-- Action Buttons -->
            <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200">
                {% if session.status == 'qr_pending' %}
                    <button onclick="showQRModal({{ session.id }}, '{{ session.qr_code }}', '{{ session.qr_expires_at.isoformat }}')" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white rounded-md" style="background-color: var(--primary-600);">
                        <i class="fas fa-qrcode mr-1"></i> View QR
                    </button>
                    <form method="POST" action="" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="refresh_qr">
                        <input type="hidden" name="session_id" value="{{ session.id }}">
                        <button type="submit" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh QR
                        </button>
                    </form>
                {% elif session.status == 'disconnected' or not session.status %}
                    <form method="POST" action="" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reconnect">
                        <input type="hidden" name="session_id" value="{{ session.id }}">
                        <button type="submit" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white rounded-md" style="background-color: var(--primary-600);">
                            <i class="fas fa-play mr-1"></i> Connect
                        </button>
                    </form>
                {% endif %}

                {% if session.status == 'connected' %}
                    <form method="POST" action="" class="inline" onsubmit="return confirm('Disconnect this session?');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="disconnect">
                        <input type="hidden" name="session_id" value="{{ session.id }}">
                        <button type="submit" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-white border border-red-300 rounded-md hover:bg-red-50">
                            <i class="fas fa-unlink mr-1"></i> Disconnect
                    </button>
                </form>
            {% endif %}
            
                {% if not session.is_primary and session.status == 'connected' %}
                    <form method="POST" action="" class="inline">
                    {% csrf_token %}
                        <input type="hidden" name="action" value="set_primary">
                        <input type="hidden" name="session_id" value="{{ session.id }}">
                        <button type="submit" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-teal-700 bg-white border border-teal-300 rounded-md hover:bg-teal-50">
                            <i class="fas fa-star mr-1"></i> Set Primary
                    </button>
                </form>
            {% endif %}
            
                <form method="POST" action="" class="inline" onsubmit="return confirm('Delete this instance? This cannot be undone.');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="session_id" value="{{ session.id }}">
                    <button type="submit" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                </form>
            </div>

            <div class="mt-3 text-xs text-gray-500">
                <i class="far fa-clock mr-1"></i>
                Created: {{ session.created_at|date:"M d, Y H:i" }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card p-12 text-center mb-6">
        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No WhatsApp Instances</h3>
        <p class="text-gray-600 mb-6">Get started by adding your first WhatsApp instance</p>
        <button onclick="showAddInstanceModal()" class="btn-primary inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2" style="--tw-ring-color: var(--primary-500);">
            <i class="fas fa-plus mr-2"></i>
            Add Your First Instance
        </button>
    </div>
            {% endif %}

    <!-- Help Section -->
    <div class="card p-6 border-l-4" style="border-left-color: var(--primary-500); background: linear-gradient(135deg, var(--primary-50) 0%, #ffffff 100%);">
        <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center">
            <i class="fas fa-question-circle mr-2" style="color: var(--primary-600);"></i>
            Need Help?
        </h3>
        <div class="space-y-2 text-sm text-gray-600">
            <p><strong>Multiple Instances:</strong> You can connect up to 10 different WhatsApp numbers to your account.</p>
            <p><strong>Primary Instance:</strong> The primary instance is used by default when sending messages via API.</p>
            <p><strong>Connection Issues:</strong> If the QR code doesn't work, try refreshing it or reconnecting the session.</p>
            <p><strong>Session Timeout:</strong> Sessions may disconnect after inactivity. Simply reconnect when needed.</p>
        </div>
    </div>
</div>

<!-- Add Instance Modal -->
<div id="addInstanceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Add New WhatsApp Instance</h3>
            <form method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_instance">
                <div class="mb-4">
                    <label for="instance_name" class="block text-sm font-medium text-gray-700 mb-2">Instance Name</label>
                    <input type="text" name="instance_name" id="instance_name" required maxlength="100"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
                           placeholder="e.g., Business Account, Personal, Support">
                    <p class="mt-1 text-xs text-gray-500">Give this instance a memorable name</p>
                </div>
                <div class="flex gap-3 justify-end">
                    <button type="button" onclick="hideAddInstanceModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white rounded-md" style="background-color: var(--primary-600);">
                        <i class="fas fa-plus mr-1"></i> Add Instance
                    </button>
                </div>
            </form>
        </div>
    </div>
        </div>

<!-- QR Code Modal -->
<div id="qrModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Scan QR Code</h3>
                <button onclick="hideQRModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-4">
                <div id="modal-countdown" class="inline-flex items-center px-4 py-2 rounded-lg border" style="background: linear-gradient(135deg, var(--primary-100) 0%, var(--primary-50) 100%); border-color: var(--primary-300);">
                    <i class="fas fa-hourglass-half mr-2" style="color: var(--primary-600);"></i>
                    <span class="text-sm font-semibold text-gray-800">
                        Expires in: <span id="modal-countdown-text" class="font-bold" style="color: var(--primary-700);">--</span>
                    </span>
                </div>
            </div>
            
            <!-- QR Code Display -->
            <div id="modal-qr-display" class="bg-white p-4 rounded-lg border-2" style="border-color: var(--primary-200);">
                <img id="modal-qr-image" src="" alt="QR Code" class="w-full">
            </div>
            
            <!-- Expired Overlay -->
            <div id="modal-qr-expired" class="hidden bg-gray-100 p-8 rounded-lg border-2 border-gray-300 text-center">
                <i class="fas fa-clock text-6xl text-gray-400 mb-4"></i>
                <h4 class="text-xl font-semibold text-gray-700 mb-2">QR Code Expired</h4>
                <p class="text-gray-600 mb-4">This QR code has expired after 60 seconds.</p>
                <p class="text-sm text-gray-500">Close this modal and click "Refresh QR" button on the instance to generate a new code.</p>
            </div>
            
            <div id="modal-instructions" class="mt-4 bg-blue-50 border border-blue-200 rounded-md p-3">
                <div class="text-xs text-blue-700">
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Open WhatsApp on your phone</li>
                        <li>Go to Menu → Linked Devices</li>
                        <li>Tap "Link a Device"</li>
                        <li>Scan this QR code</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
        
<script>
// Modal Functions
function showAddInstanceModal() {
    document.getElementById('addInstanceModal').classList.remove('hidden');
    document.getElementById('instance_name').focus();
}

function hideAddInstanceModal() {
    document.getElementById('addInstanceModal').classList.add('hidden');
    document.getElementById('instance_name').value = '';
}

let modalCountdownInterval = null;
let statusCheckInterval = null;

function showQRModal(sessionId, qrCode, expiresAt) {
    const modal = document.getElementById('qrModal');
    const qrImage = document.getElementById('modal-qr-image');
    const qrDisplay = document.getElementById('modal-qr-display');
    const qrExpired = document.getElementById('modal-qr-expired');
    const instructions = document.getElementById('modal-instructions');
    const countdownText = document.getElementById('modal-countdown-text');
    const countdownTimer = document.getElementById('modal-countdown');
    
    // Reset modal state
    qrDisplay.classList.remove('hidden');
    qrExpired.classList.add('hidden');
    instructions.classList.remove('hidden');
    countdownText.classList.remove('text-red-600');
    countdownTimer.style.background = 'linear-gradient(135deg, var(--primary-100) 0%, var(--primary-50) 100%)';
    countdownTimer.style.borderColor = 'var(--primary-300)';
    
    qrImage.src = qrCode;
    modal.classList.remove('hidden');
    
    // Setup countdown
    const qrExpiresAt = new Date(expiresAt);
    
    // Check if already expired
    const now = new Date();
    const initialTimeLeft = Math.floor((qrExpiresAt - now) / 1000);
    
    if (initialTimeLeft <= 0) {
        // Already expired
        countdownText.textContent = 'EXPIRED';
        countdownText.classList.add('text-red-600');
        countdownTimer.style.background = '#fee';
        countdownTimer.style.borderColor = '#fcc';
        qrDisplay.classList.add('hidden');
        qrExpired.classList.remove('hidden');
        instructions.classList.add('hidden');
        return;
    }
    
    if (modalCountdownInterval) {
        clearInterval(modalCountdownInterval);
    }
    
    modalCountdownInterval = setInterval(() => {
        const now = new Date();
        const timeLeft = Math.floor((qrExpiresAt - now) / 1000);
        
        if (timeLeft <= 0) {
            // QR code expired
            countdownText.textContent = 'EXPIRED';
            countdownText.classList.add('text-red-600');
            countdownTimer.style.background = '#fee';
            countdownTimer.style.borderColor = '#fcc';
            
            // Show expired overlay, hide QR code
            qrDisplay.classList.add('hidden');
            qrExpired.classList.remove('hidden');
            instructions.classList.add('hidden');
            
            clearInterval(modalCountdownInterval);
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        } else {
            // Update countdown
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when less than 15 seconds
            if (timeLeft <= 15) {
                countdownText.classList.add('text-red-600');
                countdownTimer.style.background = '#fef5e7';
                countdownTimer.style.borderColor = '#f39c12';
            }
        }
    }, 1000);
    
    // Start auto-checking connection status
    startStatusChecking();
}

function hideQRModal() {
    document.getElementById('qrModal').classList.add('hidden');
    if (modalCountdownInterval) {
        clearInterval(modalCountdownInterval);
    }
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
}

// Auto-check connection status when QR modal is open
function startStatusChecking() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    let checkCount = 0;
    const maxChecks = 180; // 3 minutes
    
    statusCheckInterval = setInterval(() => {
        checkCount++;
        
        if (checkCount > maxChecks) {
            clearInterval(statusCheckInterval);
            console.log('Status check stopped: max attempts reached');
            return;
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) return;
        
        // Check status
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': csrfToken,
                'action': 'refresh'
            }),
            cache: 'no-cache'
        })
        .then(response => response.text())
        .then(html => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const statusBadges = tempDiv.querySelectorAll('.status-badge');
            
            // Check if any session is now connected
            for (const badge of statusBadges) {
                if (badge.textContent.trim().includes('Connected')) {
                    console.log('Connection detected! Reloading...');
                    hideQRModal();
                    clearInterval(statusCheckInterval);
                    setTimeout(() => window.location.reload(), 300);
                    break;
                }
            }
        })
        .catch(err => {
            console.error('Status check failed:', err);
        });
    }, 1000);
}

// Close modals on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideAddInstanceModal();
        hideQRModal();
    }
});

// Close modals when clicking outside
document.getElementById('addInstanceModal').addEventListener('click', function(event) {
    if (event.target === this) {
        hideAddInstanceModal();
    }
});

document.getElementById('qrModal').addEventListener('click', function(event) {
    if (event.target === this) {
        hideQRModal();
    }
});

// Auto-open QR modal for newly created instances
document.addEventListener('DOMContentLoaded', function() {
    // Auto-open QR modal for the first QR pending session
    const qrPendingSessions = [
        {% for session in sessions %}
        {% if session.status == 'qr_pending' and session.qr_code %}
        {
            id: {{ session.id }},
            qrCode: '{{ session.qr_code }}',
            expiresAt: '{{ session.qr_expires_at.isoformat }}'
        },
        {% endif %}
        {% endfor %}
    ];
    
    // Show modal for the first QR pending session (most recent)
    if (qrPendingSessions.length > 0) {
        const firstPending = qrPendingSessions[0];
        setTimeout(() => {
            showQRModal(firstPending.id, firstPending.qrCode, firstPending.expiresAt);
        }, 500);
    }
});
</script>

{% endblock %}


