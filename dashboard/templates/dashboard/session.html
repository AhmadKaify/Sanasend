{% extends 'dashboard/base.html' %}

{% block title %}WhatsApp Session{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">WhatsApp Session Management</h1>
    
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Session Status</h2>
                <p class="text-sm text-gray-500 mt-1">Connect your WhatsApp account to start sending messages</p>
            </div>
            <div>
                {% if session %}
                    {% if session.status == 'connected' %}
                        <span class="status-badge px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <span class="pulse-dot bg-green-500"></span>
                            Connected
                        </span>
                    {% elif session.status == 'qr_pending' %}
                        <span class="status-badge px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <span class="pulse-dot bg-yellow-500"></span>
                            Pending Scan
                        </span>
                    {% else %}
                        <span class="status-badge px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800">
                            <span class="pulse-dot bg-red-500"></span>
                            Disconnected
                        </span>
                    {% endif %}
                {% else %}
                    <span class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        Not Initialized
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4 mb-6">
            {% if not session or session.status == 'disconnected' %}
                <form method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="init">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        <i class="fas fa-play mr-2"></i>
                        Initialize Session
                    </button>
                </form>
            {% endif %}
            
            {% if session %}
                <form method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="refresh">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        <i class="fas fa-sync mr-2"></i>
                        Refresh Status
                    </button>
                </form>
            {% endif %}
            
            {% if session and session.status == 'connected' %}
                <form method="POST" action="" onsubmit="return confirm('Are you sure you want to disconnect this session?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="disconnect">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fas fa-unlink mr-2"></i>
                        Disconnect
                    </button>
                </form>
            {% endif %}
        </div>

        <!-- QR Code Display -->
        {% if session and session.status == 'qr_pending' and session.qr_code %}
        <div class="border-t border-gray-200 pt-6" id="qr-section">
            <h3 class="text-lg font-medium text-gray-900 mb-4 text-center">Scan QR Code with WhatsApp</h3>
            
            <!-- Countdown Timer -->
            <div class="mb-4 text-center">
                <div id="countdown-timer" class="inline-flex items-center px-4 py-2 rounded-lg bg-gradient-to-r from-teal-100 to-blue-100 border border-teal-300">
                    <i class="fas fa-hourglass-half mr-2 text-teal-600"></i>
                    <span class="text-lg font-semibold text-gray-800">
                        QR expires in: <span id="countdown-text" class="text-teal-700 font-bold">--</span>
                    </span>
                </div>
            </div>
            
            <div id="qr-code-display" class="qr-code-container bg-white p-4 rounded-lg border-2 border-teal-200">
                <img src="{{ session.qr_code }}" alt="QR Code" class="w-full">
            </div>
            
            <!-- Expired overlay -->
            <div id="qr-expired" class="hidden qr-code-container bg-gray-100 p-8 rounded-lg border-2 border-gray-300 text-center">
                <i class="fas fa-clock text-6xl text-gray-400 mb-4"></i>
                <h4 class="text-xl font-semibold text-gray-700 mb-2">QR Code Expired</h4>
                <p class="text-gray-600 mb-4">This QR code has expired. Please request a new one.</p>
            </div>
            
            <!-- Request New QR Button -->
            <div class="mt-4 text-center">
                <form method="POST" action="" id="refresh-qr-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="refresh_qr">
                    <button type="submit" id="refresh-qr-btn" class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Request New QR Code
                    </button>
                </form>
            </div>
            
            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">
                            How to scan:
                        </h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <ol class="list-decimal list-inside space-y-1">
                                <li>Open WhatsApp on your phone</li>
                                <li>Tap Menu or Settings and select "Linked Devices"</li>
                                <li>Tap "Link a Device"</li>
                                <li>Point your phone at this screen to capture the QR code</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-500" id="status-check-indicator">
                    <i class="fas fa-sync fa-spin mr-1"></i>
                    <span id="status-check-text">Checking connection status...</span>
                </p>
            </div>
        </div>
        
        <script>
            // QR Code expiration time from server
            {% if session.qr_expires_at %}
                const qrExpiresAtStr = "{{ session.qr_expires_at.isoformat }}";
                const qrExpiresAt = new Date(qrExpiresAtStr);
            {% else %}
                const qrExpiresAt = new Date(Date.now() + 60000); // Default 60 seconds from now
            {% endif %}
            
            const countdownText = document.getElementById('countdown-text');
            const qrCodeDisplay = document.getElementById('qr-code-display');
            const qrExpired = document.getElementById('qr-expired');
            const refreshBtn = document.getElementById('refresh-qr-btn');
            const countdownTimer = document.getElementById('countdown-timer');
            const statusCheckText = document.getElementById('status-check-text');
            
            // Validate date
            if (isNaN(qrExpiresAt.getTime())) {
                console.error('Invalid QR expiration date');
                countdownText.textContent = '1:00';
            }
            
            // Update countdown every second
            const countdownInterval = setInterval(() => {
                const now = new Date();
                const timeLeft = Math.floor((qrExpiresAt - now) / 1000);
                
                if (timeLeft <= 0) {
                    // QR code expired
                    countdownText.textContent = 'EXPIRED';
                    countdownText.classList.remove('text-teal-700');
                    countdownText.classList.add('text-red-600');
                    countdownTimer.classList.remove('bg-gradient-to-r', 'from-teal-100', 'to-blue-100', 'border-teal-300');
                    countdownTimer.classList.add('bg-red-100', 'border-red-300');
                    
                    // Show expired overlay
                    qrCodeDisplay.classList.add('hidden');
                    qrExpired.classList.remove('hidden');
                    
                    // Highlight refresh button
                    refreshBtn.classList.add('animate-pulse');
                    
                    clearInterval(countdownInterval);
                    clearInterval(statusCheckInterval); // Stop checking when expired
                } else {
                    // Format time as MM:SS
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Change color when less than 15 seconds
                    if (timeLeft <= 15) {
                        countdownText.classList.remove('text-teal-700');
                        countdownText.classList.add('text-red-600');
                        countdownTimer.classList.remove('bg-gradient-to-r', 'from-teal-100', 'to-blue-100', 'border-teal-300');
                        countdownTimer.classList.add('bg-red-100', 'border-red-300');
                    }
                }
            }, 1000);
            
            // Auto-check connection status every 3 seconds (only if QR is pending)
            let consecutiveChecks = 0;
            let checkCount = 0;
            const maxChecks = 60; // Stop after 3 minutes (60 * 3s)
            
            const statusCheckInterval = setInterval(() => {
                checkCount++;
                
                // Stop checking after max attempts or if QR expired
                if (checkCount > maxChecks) {
                    clearInterval(statusCheckInterval);
                    console.log('Status check stopped: max attempts reached');
                    return;
                }
                
                // Check via refresh status action
                fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'action': 'refresh'
                    }),
                    cache: 'no-cache'
                })
                .then(response => response.text())
                .then(html => {
                    // Check if status changed to connected in the response
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const statusBadge = tempDiv.querySelector('.status-badge');
                    
                    if (statusBadge) {
                        const statusText = statusBadge.textContent.trim();
                        console.log('Status check:', statusText);
                        
                        if (statusText.includes('Connected')) {
                            consecutiveChecks++;
                            statusCheckText.textContent = `Connection detected! Confirming... (${consecutiveChecks}/2)`;
                            statusCheckText.parentElement.classList.add('text-green-600');
                            statusCheckText.parentElement.classList.remove('text-gray-500');
                            
                            // Require 2 consecutive checks to avoid false positives
                            if (consecutiveChecks >= 2) {
                                console.log('Connection confirmed! Reloading...');
                                statusCheckText.textContent = 'Connected! Reloading page...';
                                clearInterval(countdownInterval);
                                clearInterval(statusCheckInterval);
                                setTimeout(() => window.location.reload(), 500);
                            }
                        } else {
                            if (consecutiveChecks > 0) {
                                statusCheckText.textContent = 'Checking connection status...';
                                statusCheckText.parentElement.classList.remove('text-green-600');
                                statusCheckText.parentElement.classList.add('text-gray-500');
                            }
                            consecutiveChecks = 0;
                        }
                    }
                })
                .catch(err => {
                    console.error('Status check failed:', err);
                    consecutiveChecks = 0;
                });
            }, 3000);
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                clearInterval(countdownInterval);
                clearInterval(statusCheckInterval);
            });
        </script>
        {% endif %}

        <!-- Session Information -->
        {% if session %}
        <div class="border-t border-gray-200 pt-6 mt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Session Details</h3>
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Session ID</dt>
                    <dd class="mt-1 text-sm text-gray-900 font-mono break-all">{{ session.session_id }}</dd>
                </div>
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                    <dd class="mt-1 text-sm text-gray-900 capitalize">{{ session.status }}</dd>
                </div>
                {% if session.phone_number %}
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Connected Phone</dt>
                    <dd class="mt-1 text-sm text-gray-900">+{{ session.phone_number }}</dd>
                </div>
                {% endif %}
                {% if session.connected_at %}
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Connected At</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ session.connected_at|date:"F d, Y - H:i:s" }}</dd>
                </div>
                {% endif %}
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Last Activity</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if session.last_active_at %}
                            {{ session.last_active_at|date:"F d, Y - H:i:s" }}
                        {% else %}
                            Never
                        {% endif %}
                    </dd>
                </div>
                <div class="border-l-4 border-teal-500 pl-4">
                    <dt class="text-sm font-medium text-gray-500">Created</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ session.created_at|date:"F d, Y - H:i:s" }}</dd>
                </div>
            </dl>
        </div>
        {% endif %}
    </div>

    <!-- Help Section -->
    <div class="bg-gradient-to-r from-teal-50 to-blue-50 rounded-lg p-6 border border-teal-100">
        <h3 class="text-lg font-medium text-gray-900 mb-3">
            <i class="fas fa-question-circle text-teal-600 mr-2"></i>
            Need Help?
        </h3>
        <div class="space-y-2 text-sm text-gray-600">
            <p><strong>Connection Issues:</strong> If the QR code doesn't work, try disconnecting and reinitializing the session.</p>
            <p><strong>Multiple Devices:</strong> WhatsApp only allows one active Web session at a time per phone number.</p>
            <p><strong>Session Timeout:</strong> Sessions may disconnect after inactivity. Simply reconnect when needed.</p>
        </div>
    </div>
</div>
{% endblock %}


